let DEFAULTS={showAllSuggestions:!1,suggestionsThreshold:1,maximumItems:0,autoselectFirst:!0,updateOnSelect:!1,highlightTyped:!1,fullWidth:!1,fixed:!1,fuzzy:!1,activeClasses:["bg-primary","text-white"],labelField:"label",valueField:"value",searchFields:["label"],queryParam:"query",items:[],source:null,hiddenInput:!1,hiddenValue:"",datalist:"",server:"",serverMethod:"GET",serverParams:{},serverDataKey:"data",fetchOptions:{},liveServer:!1,noCache:!0,debounceTime:300,notFoundMessage:"",onRenderItem:(e,t,i)=>t,onSelectItem(e,t){},onServerResponse:(e,t)=>e.json(),onChange(e,t){}},LOADING_CLASS="is-loading",ACTIVE_CLASS="is-active",SHOW_CLASS="show",NEXT="next",PREV="prev",INSTANCE_MAP=new WeakMap,counter=0,activeCounter=0;function debounce(e,t=300){let i;return(...s)=>{clearTimeout(i),i=setTimeout(()=>{e.apply(this,s)},t)}}function removeDiacritics(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function normalize(e){return e?removeDiacritics(e.toString()).toLowerCase():""}function fuzzyMatch(e,t){if(0==e.indexOf(t))return!0;let i=0;for(let s=0;s<t.length;s++){let n=t[s];if(" "!=n&&(i=e.indexOf(n,i)+1)<=0)return!1}return!0}function insertAfter(e,t){return e.parentNode.insertBefore(t,e.nextSibling)}function decodeHtml(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}function attrs(e,t){for(let[i,s]of Object.entries(t))e.setAttribute(i,s)}class Autocomplete{constructor(e,t={}){if(!(e instanceof HTMLElement)){console.error("Invalid element",e);return}INSTANCE_MAP.set(e,this),counter++,activeCounter++,this._searchInput=e,this._configure(t),this._preventInput=!1,this._keyboardNavigation=!1,this._searchFunc=debounce(()=>{this._loadFromServer(!0)},this._config.debounceTime),this._configureSearchInput(),this._configureDropElement(),this._config.fixed&&(document.addEventListener("scroll",this,!0),window.addEventListener("resize",this)),this._searchInput.addEventListener("focus",this),this._searchInput.addEventListener("change",this),this._searchInput.addEventListener("blur",this),this._searchInput.addEventListener("input",this),this._searchInput.addEventListener("keydown",this),this._dropElement.addEventListener("mousemove",this),this._fetchData()}static init(e="input.autocomplete",t={}){let i=document.querySelectorAll(e);i.forEach(e=>{this.getOrCreateInstance(e,t)})}static getInstance(e){return INSTANCE_MAP.has(e)?INSTANCE_MAP.get(e):null}static getOrCreateInstance(e,t={}){return this.getInstance(e)||new this(e,t)}dispose(){activeCounter--,this._searchInput.removeEventListener("focus",this),this._searchInput.removeEventListener("change",this),this._searchInput.removeEventListener("blur",this),this._searchInput.removeEventListener("input",this),this._searchInput.removeEventListener("keydown",this),this._dropElement.removeEventListener("mousemove",this),this._config.fixed&&activeCounter<=0&&(document.removeEventListener("scroll",this,!0),window.removeEventListener("resize",this)),this._dropElement.parentElement.removeChild(this._dropElement),INSTANCE_MAP.delete(this._searchInput)}handleEvent(e){["scroll","resize"].includes(e.type)?(this._timer&&window.cancelAnimationFrame(this._timer),this._timer=window.requestAnimationFrame(()=>{this[`on${e.type}`](e)})):this[`on${e.type}`](e)}_configure(e={}){this._config=Object.assign({},DEFAULTS);let t={...e,...this._searchInput.dataset},i=e=>["true","false","1","0",!0,!1].includes(e)&&!!JSON.parse(e);for(let[s,n]of Object.entries(DEFAULTS)){if(void 0===t[s])continue;let r=t[s];switch(typeof n){case"number":this._config[s]=parseInt(r);break;case"boolean":this._config[s]=i(r);break;case"string":this._config[s]=r.toString();break;case"object":if(Array.isArray(n)){if("string"==typeof r){let o=r.includes("|")?"|":",";this._config[s]=r.split(o)}else this._config[s]=r}else this._config[s]="string"==typeof r?JSON.parse(r):r;break;case"function":this._config[s]="string"==typeof r?window[r]:r;break;default:this._config[s]=r}}}_configureSearchInput(){this._searchInput.autocomplete="field-"+Date.now(),this._searchInput.spellcheck=!1,attrs(this._searchInput,{"aria-auto-complete":"list","aria-has-popup":"menu","aria-expanded":"false",role:"combobox"}),this._hiddenInput=null,this._config.hiddenInput&&(this._hiddenInput=document.createElement("input"),this._hiddenInput.type="hidden",this._hiddenInput.value=this._config.hiddenValue,this._hiddenInput.name=this._searchInput.name,this._searchInput.name="_"+this._searchInput.name,insertAfter(this._searchInput,this._hiddenInput))}_configureDropElement(){this._dropElement=document.createElement("ul"),this._dropElement.id="ac-menu-"+counter,this._dropElement.setAttribute("role","menu"),this._dropElement.classList.add(...["dropdown-menu","autocomplete-menu","p-0"]),this._dropElement.style.maxHeight="280px",this._config.fullWidth||(this._dropElement.style.maxWidth="360px"),this._config.fixed&&(this._dropElement.style.position="fixed"),this._dropElement.style.overflowY="auto",this._dropElement.style.overscrollBehavior="contain",this._dropElement.style.textAlign="unset",insertAfter(this._searchInput,this._dropElement),this._searchInput.setAttribute("aria-controls",this._dropElement.id)}oninput(e){!this._preventInput&&(this._hiddenInput&&(this._hiddenInput.value=null),this.showOrSearch())}onchange(e){let t=this._searchInput.value,i=Object.values(this._items).find(e=>e.label===t);this._config.onChange(i,this)}onblur(e){this.hideSuggestions()}onfocus(e){this.showOrSearch()}onkeydown(e){let t=e.keyCode||e.key;switch(t){case 13:case"Enter":if(this.isDropdownVisible()){e.preventDefault();let i=this.getSelection();i&&i.click()}break;case 38:case"ArrowUp":e.preventDefault(),this._keyboardNavigation=!0,this._moveSelection(PREV);break;case 40:case"ArrowDown":e.preventDefault(),this._keyboardNavigation=!0,this.isDropdownVisible()?this._moveSelection(NEXT):this.showOrSearch(!1);break;case 27:case"Escape":this.isDropdownVisible()&&(this._searchInput.focus(),this.hideSuggestions())}}onmousemove(e){this._keyboardNavigation=!1}onscroll(e){this._positionMenu()}onresize(e){this._positionMenu()}getConfig(e=null){return null!==e?this._config[e]:this._config}setConfig(e,t){this._config[e]=t}setData(e){this._items={},this._addItems(e)}enable(){this._searchInput.setAttribute("disabled","")}disable(){this._searchInput.removeAttribute("disabled")}isDisabled(){return this._searchInput.hasAttribute("disabled")||this._searchInput.disabled||this._searchInput.hasAttribute("readonly")}isDropdownVisible(){return this._dropElement.classList.contains(SHOW_CLASS)}getSelection(){return this._dropElement.querySelector("a."+ACTIVE_CLASS)}removeSelection(){let e=this.getSelection();e&&e.classList.remove(...this._activeClasses())}_activeClasses(){return[...this._config.activeClasses,ACTIVE_CLASS]}_isItemEnabled(e){if("none"===e.style.display)return!1;let t=e.firstElementChild;return"A"===t.tagName&&!t.classList.contains("disabled")}_moveSelection(e=NEXT,t=null){let i=this.getSelection();if(i){let s=e===NEXT?"nextSibling":"previousSibling";t=i.parentNode;do t=t[s];while(t&&!this._isItemEnabled(t));t?(i.classList.remove(...this._activeClasses()),e===PREV?t.parentNode.scrollTop=t.offsetTop-t.parentNode.offsetTop:t.offsetTop>t.parentNode.offsetHeight-t.offsetHeight&&(t.parentNode.scrollTop+=t.offsetHeight)):i&&(t=i.parentElement)}else{if(e===PREV)return t;if(!t)for(t=this._dropElement.firstChild;t&&!this._isItemEnabled(t);)t=t.nextSibling}if(t){let n=t.querySelector("a");n.classList.add(...this._activeClasses()),this._searchInput.setAttribute("aria-activedescendant",n.id),this._config.updateOnSelect&&(this._searchInput.value=n.dataset.label)}else this._searchInput.setAttribute("aria-activedescendant","");return t}_shouldShow(){return!this.isDisabled()&&this._searchInput.value.length>=this._config.suggestionsThreshold}showOrSearch(e=!0){if(e&&!this._shouldShow()){this.hideSuggestions();return}this._config.liveServer?this._searchFunc():this._config.source?this._config.source(this._searchInput.value,e=>{this.setData(e),this._showSuggestions()}):this._showSuggestions()}_createGroup(e){let t=document.createElement("li");t.setAttribute("role","presentation");let i=document.createElement("span");return t.append(i),i.classList.add(...["dropdown-header","text-truncate"]),i.innerHTML=e,t}_createItem(e,t){let i=t.label;if(this._config.highlightTyped){let s=normalize(i).indexOf(e);i=i.substring(0,s)+`<mark>${i.substring(s,s+e.length)}</mark>`+i.substring(s+e.length,i.length)}i=this._config.onRenderItem(t,i,this);let n=document.createElement("li");n.setAttribute("role","presentation");let r=document.createElement("a");if(n.append(r),r.id=this._dropElement.id+"-"+this._dropElement.children.length,r.classList.add(...["dropdown-item","text-truncate"]),r.setAttribute("data-value",t.value),r.setAttribute("data-label",t.label),r.setAttribute("tabindex","-1"),r.setAttribute("role","menuitem"),r.setAttribute("href","#"),r.innerHTML=i,t.data)for(let[o,a]of Object.entries(t.data))r.dataset[o]=a;return r.addEventListener("mouseenter",e=>{!this._keyboardNavigation&&(this.removeSelection(),n.querySelector("a").classList.add(...this._activeClasses()))}),r.addEventListener("mousedown",e=>{e.preventDefault()}),r.addEventListener("click",e=>{e.preventDefault(),this._preventInput=!0,this._searchInput.value=decodeHtml(t.label),this._hiddenInput&&(this._hiddenInput.value=t.value),this._config.onSelectItem(t,this),this.hideSuggestions(),this._preventInput=!1}),n}_showSuggestions(){if(document.activeElement!=this._searchInput)return;let e=normalize(this._searchInput.value);this._dropElement.innerHTML="";let t=Object.keys(this._items),i=0,s=null,n=[];for(let r=0;r<t.length;r++){let o=t[r],a=this._items[o],h=this._config.showAllSuggestions||0===e.length,l=0==e.length&&0===this._config.suggestionsThreshold;!h&&e.length>0&&this._config.searchFields.forEach(t=>{let i=normalize(a[t]),s=this._config.fuzzy?fuzzyMatch(i,e):0==i.indexOf(e);s&&(l=!0)});let u=l||0===e.length;if(h||l){if(i++,a.group&&!n.includes(a.group)){let c=this._createGroup(a.group);this._dropElement.appendChild(c),n.push(a.group)}let d=this._createItem(e,a);if(!s&&u&&(s=d),this._dropElement.appendChild(d),this._config.maximumItems>0&&i>=this._config.maximumItems)break}}if(s&&this._config.autoselectFirst&&(this.removeSelection(),this._moveSelection(NEXT,s)),0===i){if(this._config.notFoundMessage){let p=document.createElement("li");p.setAttribute("role","presentation"),p.innerHTML=`<span class="dropdown-item">${this._config.notFoundMessage}</span>`,this._dropElement.appendChild(p),this._showDropdown()}else this.hideSuggestions()}else this._showDropdown()}_showDropdown(){this._dropElement.classList.add(SHOW_CLASS),attrs(this._searchInput,{"aria-expanded":"true"}),this._positionMenu()}toggleSuggestions(e=!0){this._dropElement.classList.contains(SHOW_CLASS)?this.hideSuggestions():this.showOrSearch(e)}hideSuggestions(){this._dropElement.classList.remove(SHOW_CLASS),attrs(this._searchInput,{"aria-expanded":"false"}),this.removeSelection()}getInput(){return this._searchInput}getDropMenu(){return this._dropElement}_positionMenu(){let e=window.getComputedStyle(this._searchInput),t=this._searchInput.getBoundingClientRect(),i="rtl"===e.direction,s=null,n=null;this._config.fixed&&(s=t.x,n=t.y+t.height,i&&!this._config.fullWidth&&(s-=this._dropElement.offsetWidth-t.width)),this._dropElement.style.transform="unset",this._config.fullWidth&&(this._dropElement.style.width=this._searchInput.offsetWidth+"px"),null!==s&&(this._dropElement.style.left=s+"px"),null!==n&&(this._dropElement.style.top=n+"px");let r=this._dropElement.getBoundingClientRect(),o=window.innerHeight;r.y+r.height>o&&(this._dropElement.style.transform="translateY(calc(-100% - "+this._searchInput.offsetHeight+"px))")}_fetchData(){this._items={},this._addItems(this._config.items);let e=this._config.datalist;if(e){let t=document.querySelector(`#${e}`);if(t){let i=Array.from(t.children).map(e=>{let t=e.getAttribute("value")??e.innerHTML.toLowerCase(),i=e.innerHTML;return{value:t,label:i}});this._addItems(i)}else console.error(`Datalist not found ${e}`)}this._setHiddenVal(),this._config.server&&!this._config.liveServer&&this._loadFromServer()}_setHiddenVal(){if(this._config.hiddenInput&&!this._config.hiddenValue)for(let[e,t]of Object.entries(this._items))t.label==this._searchInput.value&&(this._hiddenInput.value=e)}_addItems(e){let t=Object.keys(e);for(let i=0;i<t.length;i++){let s=t[i],n=e[s];if(n.group&&n.items){n.items.forEach(e=>e.group=n.group),this._addItems(n.items);continue}let r="string"==typeof n?n:n.label,o="object"!=typeof n?{}:n;o.label=n[this._config.labelField]??r,o.value=n[this._config.valueField]??s,o.label&&(this._items[o.value]=o)}}_loadFromServer(e=!1){this._abortController&&this._abortController.abort(),this._abortController=new AbortController;let t=this._searchInput.dataset.serverParams||{};"string"==typeof t&&(t=JSON.parse(t));let i=Object.assign({},this._config.serverParams,t);if(i[this._config.queryParam]=this._searchInput.value,this._config.noCache&&(i.t=Date.now()),i.related){let s=document.getElementById(i.related);if(s){i.related=s.value;let n=s.getAttribute("name");n&&(i[n]=s.value)}}let r=new URLSearchParams(i),o=this._config.server,a=Object.assign(this._config.fetchOptions,{method:this._config.serverMethod||"GET",signal:this._abortController.signal});"POST"===a.method?a.body=r:o+="?"+r.toString(),this._searchInput.classList.add(LOADING_CLASS),fetch(o,a).then(e=>this._config.onServerResponse(e,this)).then(t=>{let i=t[this._config.serverDataKey]||t;this.setData(i),this._setHiddenVal(),this._abortController=null,e&&this._showSuggestions()}).catch(e=>{"AbortError"!==e.name&&console.error(e)}).finally(e=>{this._searchInput.classList.remove(LOADING_CLASS)})}}export default Autocomplete;